# üîì AN√ÅLISIS COMPLETO: ¬øQu√© Ocurre al Presionar "ABRIR JORNADA"?

## ‚ö†Ô∏è IMPORTANTE: Confusi√≥n de Nombres

El bot√≥n dice **"Abrir Cambios"** pero internamente llama a **`closeAllJornadas()`**

Esta confusi√≥n viene de que:
- **"Abrir Cambios"** = Cerrar la jornada y permitir modificaciones para la siguiente
- **"Cerrar Jornada"** en el c√≥digo = Finalizar jornada actual y abrir la siguiente

## üì± FLUJO COMPLETO PASO A PASO

### 1Ô∏è‚É£ FRONTEND: Usuario Presiona el Bot√≥n

**Archivo**: `frontend/pages/admin/AdminPanel.tsx`  
**L√≠nea**: 555

```tsx
<TouchableOpacity onPress={handleAbrirJornada}>
  Abrir Cambios (Jornada X)
</TouchableOpacity>
```

**Estado inicial del bot√≥n**:
- Solo visible si `jornadaStatus === 'closed'` (jornada bloqueada)
- Deshabilitado si `jornadaStatus === 'open'` (ya procesada)

---

### 2Ô∏è‚É£ FRONTEND: Confirmaci√≥n del Usuario

**Archivo**: `frontend/pages/admin/AdminPanel.tsx`  
**L√≠neas**: 154-215

Se muestra un **Alert de confirmaci√≥n** con toda la informaci√≥n:

```
üîì Abrir Cambios

¬øEst√°s seguro de que quieres abrir los cambios para TODAS las ligas?

Esto ejecutar√° el siguiente proceso:

üìä EVALUACI√ìN Y C√ÅLCULOS:
‚Ä¢ Evaluar√° todas las apuestas con resultados reales
‚Ä¢ Calcular√° puntos de plantillas
‚Ä¢ Actualizar√° presupuestos (500M base + puntos + apuestas)
‚Ä¢ Actualizar√° clasificaci√≥n total

üóëÔ∏è LIMPIEZA:
‚Ä¢ Vaciar√° todas las plantillas
‚Ä¢ Eliminar√° opciones de apuestas antiguas

‚è≠Ô∏è AVANCE:
‚Ä¢ Incrementar√° jornada en +1
‚Ä¢ Desbloquear√° modificaciones para nueva jornada

‚ö†Ô∏è Este proceso puede tardar varios minutos.
```

**Opciones**:
- ‚ùå **Cancelar** ‚Üí No hace nada
- ‚úÖ **Abrir Cambios** ‚Üí Ejecuta el proceso

---

### 3Ô∏è‚É£ FRONTEND: Llamada al Servicio

**Archivo**: `frontend/pages/admin/AdminPanel.tsx`  
**L√≠nea**: 187

```typescript
const result = await JornadaService.closeAllJornadas();
```

**Estado visual**:
- Muestra loading spinner: `"Abriendo Cambios (Jornada X)..."`
- Deshabilita el bot√≥n para evitar clics m√∫ltiples

---

### 4Ô∏è‚É£ FRONTEND: Servicio HTTP

**Archivo**: `frontend/services/JornadaService.ts`  
**L√≠neas**: 246-288

```typescript
static async closeAllJornadas() {
  const token = await EncryptedStorage.getItem('accessToken');
  
  const response = await axios.post(
    `${API_URL}/jornada/close-all`,
    {},
    {
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      timeout: 180000, // 3 minutos
    }
  );
  
  return response.data;
}
```

**Request HTTP**:
- **M√©todo**: POST
- **URL**: `http://localhost:5000/api/jornada/close-all`
- **Headers**: Authorization token
- **Body**: {} (vac√≠o)
- **Timeout**: 180 segundos (3 minutos)

---

### 5Ô∏è‚É£ BACKEND: Ruta HTTP

**Archivo**: `backend/src/routes/jornada.routes.ts`  
**L√≠neas**: 70-76

```typescript
fastify.post(
  '/close-all',
  {
    preHandler: [fastify.auth], // ‚úÖ Requiere autenticaci√≥n
  },
  JornadaController.closeAllJornadas
);
```

**Middleware**:
- Verifica token de autenticaci√≥n
- Si no hay token ‚Üí 401 Unauthorized
- Si token v√°lido ‚Üí Contin√∫a

---

### 6Ô∏è‚É£ BACKEND: Controlador

**Archivo**: `backend/src/controllers/jornada.controller.ts`  
**L√≠neas**: 212-228

```typescript
static async closeAllJornadas(request, reply) {
  try {
    const result = await JornadaService.closeAllJornadas();
    return reply.status(200).send(result);
  } catch (error) {
    console.error('Error en closeAllJornadas:', error);
    return reply.status(500).send({ 
      error: error.message || 'Error al cerrar jornadas' 
    });
  }
}
```

---

### 7Ô∏è‚É£ BACKEND: Servicio Principal

**Archivo**: `backend/src/services/jornada.service.ts`  
**L√≠neas**: 1161-1242

```typescript
static async closeAllJornadas() {
  console.log('\nüåç CERRANDO JORNADA PARA TODAS LAS LIGAS...\n');
  
  // Obtener TODAS las ligas
  const leagues = await prisma.league.findMany();
  
  for (const league of leagues) {
    console.log(`üèÜ Procesando liga: ${league.name}`);
    
    // Llamar a closeJornada para cada liga
    const result = await this.closeJornada(league.id);
  }
}
```

**Itera sobre TODAS las ligas** y ejecuta `closeJornada()` para cada una.

---

## üîÑ PROCESO DE `closeJornada()` (POR CADA LIGA)

**Archivo**: `backend/src/services/jornada.service.ts`  
**M√©todo**: `closeJornada(leagueId)`  
**L√≠neas**: 895-1045

---

### üìä PASO 1: Evaluar Apuestas

**L√≠nea**: 920

```typescript
const evaluations = await this.evaluateJornadaBets(jornada, leagueId);
```

**Proceso**:
1. Obtiene todas las apuestas con `status: 'pending'` de la jornada actual
2. Para cada apuesta:
   - Consulta la API Football para obtener el resultado del partido
   - Verifica si el partido termin√≥ (`status: 'FT'`, `'AET'`, `'PEN'`)
   - Eval√∫a la apuesta seg√∫n el tipo:
     - **Ganador local**: `goalsHome > goalsAway`
     - **Ganador visitante**: `goalsAway > goalsHome`
     - **Empate**: `goalsHome === goalsAway`
     - **M√°s de X goles**: `totalGoals > threshold`
     - **Menos de X goles**: `totalGoals < threshold`
     - **M√°s de X corners**: `totalCorners > threshold`
     - **Menos de X corners**: `totalCorners < threshold`
     - **Ambos marcan**: `goalsHome > 0 && goalsAway > 0`
     - **M√°s de X tarjetas**: `totalCards > threshold`
   - Si gan√≥:
     ```typescript
     profit = amount √ó odd
     status = 'won'
     ```
   - Si perdi√≥:
     ```typescript
     profit = -amount
     status = 'lost'
     ```
3. Actualiza cada apuesta en BD con `status` y `profit`

**Ejemplo**:
```
Apuesta 1: 10M √ó 1.8 = gan√≥ ‚Üí profit: +18M, status: 'won'
Apuesta 2: 15M √ó 2.0 = perdi√≥ ‚Üí profit: -15M, status: 'lost'
Apuesta 3: 5M √ó 1.5 = gan√≥ ‚Üí profit: +7.5M, status: 'won'
```

**Console**:
```
üìä 1. Evaluando apuestas de jornada 5...
‚úÖ 23 apuestas evaluadas
```

---

### üí∞ PASO 2: Calcular Balances de Apuestas

**L√≠nea**: 925

```typescript
const balances = await this.calculateUserBalances(leagueId, evaluations);
```

**Proceso**:
1. Agrupa las apuestas evaluadas por usuario
2. Para cada usuario, calcula:
   ```typescript
   {
     userId: "abc123",
     totalProfit: 10.5,  // +18 - 15 + 7.5 = +10.5M
     wonBets: 2,
     lostBets: 1,
     squadPoints: 0  // Todav√≠a no calculado
   }
   ```

**Console**:
```
üí∞ 2. Calculando balances de apuestas...
‚úÖ Balances calculados para 8 usuarios
```

---

### ‚öΩ PASO 3: Calcular Puntos de Plantilla

**L√≠neas**: 930-951

```typescript
for (const member of allMembers) {
  const squadPoints = await this.calculateSquadPoints(
    member.userId, 
    leagueId, 
    jornada
  );
  
  userBalance.squadPoints = squadPoints;
}
```

**Proceso detallado** (m√©todo `calculateSquadPoints`):

#### 3.1. Obtener Plantilla
```typescript
const squad = await prisma.squad.findUnique({
  where: { userId_leagueId: { userId, leagueId } },
  include: { players: true }
});
```

#### 3.2. Validar N√∫mero de Jugadores
```typescript
if (squad.players.length < 11) {
  return 0; // ‚ùå Plantilla inv√°lida
}
```

#### 3.3. Por Cada Jugador (11 iteraciones):

**A) Obtener equipo del jugador**
```typescript
// Primero intenta desde BD local
const localPlayer = await prisma.player.findUnique({ 
  where: { id: playerId } 
});
playerTeamId = localPlayer.teamId;

// Si no est√° en BD, consulta API
const playerInfo = await api.get('/players', {
  params: { id: playerId, season: 2025, league: 140 }
});
```

**B) Obtener partidos de la jornada**
```typescript
const fixtures = await api.get('/fixtures', {
  params: {
    league: 140,
    season: 2025,
    round: `Regular Season - ${jornada}`
  }
});
```

**C) Buscar el partido del equipo**
```typescript
const teamFixture = fixtures.find(f => 
  f.teams.home.id === playerTeamId || 
  f.teams.away.id === playerTeamId
);
```

**D) Obtener estad√≠sticas del jugador**
```typescript
const statsResponse = await api.get('/fixtures/players', {
  params: { fixture: teamFixture.fixture.id }
});

// Buscar el jugador en las estad√≠sticas
const playerStats = teamsData.find(team =>
  team.players.find(p => p.player.id === playerId)
);
```

**E) Calcular puntos**
```typescript
const points = calculatePlayerPointsService(
  playerStats, 
  mapSquadRole(squadPlayer.role)
);
```

**Reglas de puntos** (`shared/pointsCalculator.ts`):
```typescript
// Ejemplo para un defensa:
- Jugar 60+ minutos: +1 punto
- Gol: +6 puntos
- Asistencia: +3 puntos
- Porter√≠a a cero: +4 puntos
- Tarjeta amarilla: -1 punto
- Tarjeta roja: -3 puntos
- Gol en contra: -2 puntos
- ...
```

#### 3.4. Sumar Puntos Totales
```typescript
totalPoints += playerPoints;
```

**Ejemplo completo**:
```
Portero (90 min, 5 paradas, 0 goles):  +8 puntos
Defensa 1 (90 min, porter√≠a a cero):   +5 puntos
Defensa 2 (90 min, porter√≠a a cero):   +5 puntos
Defensa 3 (45 min):                    +0 puntos
Defensa 4 (90 min, 1 gol):             +11 puntos
Centrocampista 1 (90 min, 1 asist):    +4 puntos
Centrocampista 2 (90 min):             +1 punto
Centrocampista 3 (70 min, amarilla):   +0 puntos
Centrocampista 4 (60 min):             +1 punto
Delantero 1 (90 min, 2 goles):         +10 puntos
Delantero 2 (30 min):                  +0 puntos
---------------------------------------------------
TOTAL:                                  45 puntos
```

**Console**:
```
‚öΩ 3. Calculando puntos de plantilla...
  üìã Plantilla encontrada con 11 jugadores
  ‚úÖ Plantilla v√°lida. Calculando puntos...
  
    üîç ===== PROCESANDO JUGADOR =====
       Nombre: Courtois
       ID: 629
       Rol: POR
       ‚è±Ô∏è Minutos: 90
       ‚öΩ PUNTOS: 8
       üí∞ Total acumulado: 8
       ====================================
  
  ... (repite para los 11 jugadores)
  
  üìä TOTAL PUNTOS PLANTILLA: 45
‚úÖ Puntos de plantilla calculados
```

---

### üíµ PASO 4: Actualizar Presupuestos y Puntos

**L√≠neas**: 954-989

```typescript
for (const [userId, balance] of balances) {
  const member = await prisma.leagueMember.findUnique({
    where: { leagueId_userId: { leagueId, userId } }
  });
  
  // ‚úÖ F√ìRMULA DEL NUEVO PRESUPUESTO
  const budgetFromBets = balance.totalProfit;      // Ej: +10.5M
  const budgetFromSquad = balance.squadPoints;     // Ej: 45M
  const newBudget = 500 + budgetFromSquad + budgetFromBets;
  // 500 + 45 + 10.5 = 555.5M ‚Üí 555M (truncado)
  
  // ‚úÖ ACTUALIZAR PUNTOS TOTALES (ACUMULADO)
  const newTotalPoints = member.points + balance.squadPoints;
  // 120 + 45 = 165 puntos
  
  await prisma.leagueMember.update({
    where: { leagueId_userId: { leagueId, userId } },
    data: {
      budget: newBudget,           // ‚úÖ NUEVO: 555M
      bettingBudget: 250,          // ‚úÖ RESETEA: 250M
      points: newTotalPoints,      // ‚úÖ ACUMULA: 165
      // initialBudget: 500        // ‚ùå NO CAMBIA
    }
  });
}
```

**Ejemplo de actualizaci√≥n**:
```
Usuario: Juan P√©rez

ANTES:
  budget: 480M
  bettingBudget: 120M (lo que qued√≥)
  points: 120
  initialBudget: 500M

C√ÅLCULOS:
  Base: 500M
  Apuestas: 2W/1L = +10.5M
  Plantilla: 45 puntos = +45M
  Nuevo presupuesto: 500 + 45 + 10.5 = 555.5M ‚Üí 555M

DESPU√âS:
  budget: 555M          ‚Üê ACTUALIZADO
  bettingBudget: 250M   ‚Üê RESETEADO
  points: 165           ‚Üê ACUMULADO (120 + 45)
  initialBudget: 500M   ‚Üê SIN CAMBIOS
```

**Console**:
```
üíµ 4. Actualizando presupuestos...
  üë§ Usuario Juan P√©rez:
     Presupuesto anterior: 480M
     Base: 500M
     Apuestas: 2W/1L = +10.5M
     Plantilla: 45 puntos = +45M
     Nuevo presupuesto: 555M
     Puntos totales: 120 ‚Üí 165
‚úÖ 8 miembros actualizados
```

---

### üóëÔ∏è PASO 5: Vaciar Plantillas

**L√≠neas**: 992-1005

```typescript
const allSquads = await prisma.squad.findMany({
  where: { leagueId }
});

for (const squad of allSquads) {
  await prisma.squadPlayer.deleteMany({
    where: { squadId: squad.id }
  });
}
```

**Proceso**:
1. Obtiene todas las plantillas de la liga
2. Para cada plantilla, elimina TODOS los `SquadPlayer` (los 11 jugadores)
3. La plantilla (tabla `Squad`) sigue existiendo, pero vac√≠a

**Resultado**:
```
Antes: 
  Squad ID abc123 ‚Üí 11 jugadores
  Squad ID def456 ‚Üí 11 jugadores
  Squad ID ghi789 ‚Üí 11 jugadores

Despu√©s:
  Squad ID abc123 ‚Üí 0 jugadores
  Squad ID def456 ‚Üí 0 jugadores
  Squad ID ghi789 ‚Üí 0 jugadores
```

**Console**:
```
üóëÔ∏è  5. Vaciando plantillas...
‚úÖ 8 plantillas vaciadas
```

---

### üóëÔ∏è PASO 6: Eliminar Opciones de Apuesta

**L√≠neas**: 1007-1013

```typescript
await prisma.bet_option.deleteMany({
  where: {
    leagueId,
    jornada  // Jornada actual (la que acabamos de cerrar)
  }
});
```

**Proceso**:
- Elimina TODAS las opciones de apuesta creadas para esta jornada
- Ejemplo: Si hab√≠a 50 opciones de apuesta creadas para la jornada 5, se eliminan las 50

**Console**:
```
üóëÔ∏è  6. Eliminando opciones de apuestas antiguas...
‚úÖ 50 opciones de apuestas eliminadas
```

---

### üóëÔ∏è PASO 7: Eliminar Apuestas Evaluadas

**L√≠neas**: 1015-1021

```typescript
await prisma.bet.deleteMany({
  where: {
    leagueId,
    jornada,
    status: { in: ['won', 'lost'] }
  }
});
```

**Proceso**:
- Elimina todas las apuestas que ya fueron evaluadas (`won` o `lost`)
- Las apuestas pendientes (si las hubiera) NO se eliminan
- Ya no necesitamos este historial porque los resultados ya se aplicaron al presupuesto

**Console**:
```
üóëÔ∏è  7. Eliminando apuestas evaluadas...
‚úÖ 23 apuestas eliminadas
```

---

### ‚è≠Ô∏è PASO 8: Avanzar Jornada

**L√≠neas**: 1023-1030

```typescript
const nextJornada = jornada + 1;

await prisma.league.update({
  where: { id: leagueId },
  data: {
    currentJornada: nextJornada,  // 5 ‚Üí 6
    jornadaStatus: 'open'         // 'closed' ‚Üí 'open'
  }
});
```

**Proceso**:
1. Incrementa el n√∫mero de jornada en +1
2. Cambia el estado a `'open'` (permite modificaciones)

**Ejemplo**:
```
ANTES:
  currentJornada: 5
  jornadaStatus: 'closed'  ‚Üê Bloqueado (no se puede modificar plantilla ni apostar)

DESPU√âS:
  currentJornada: 6
  jornadaStatus: 'open'    ‚Üê Desbloqueado (se puede modificar plantilla y apostar)
```

**Console**:
```
‚è≠Ô∏è  8. Avanzando jornada...
‚úÖ Liga avanzada a jornada 6 con estado "open"

üéâ JORNADA 5 CERRADA EXITOSAMENTE

üìä Resumen:
   - 23 apuestas evaluadas
   - 8 miembros actualizados
   - 8 plantillas vaciadas
   - 50 opciones de apuestas eliminadas
   - Jornada actual: 6
```

---

## üîÑ RESUMEN GLOBAL (Todas las Ligas)

Despu√©s de procesar **TODAS** las ligas, el backend devuelve:

```json
{
  "success": true,
  "message": "Jornada cerrada para 3 ligas",
  "leaguesProcessed": 3,
  "totalEvaluations": 67,
  "totalUpdatedMembers": 24,
  "totalClearedSquads": 24,
  "leagues": [
    {
      "id": "liga1",
      "name": "Liga Amigos",
      "oldJornada": 5,
      "newJornada": 6,
      "evaluations": 23,
      "updatedMembers": 8,
      "clearedSquads": 8
    },
    {
      "id": "liga2",
      "name": "Liga Trabajo",
      "oldJornada": 5,
      "newJornada": 6,
      "evaluations": 30,
      "updatedMembers": 10,
      "clearedSquads": 10
    },
    {
      "id": "liga3",
      "name": "Liga Familia",
      "oldJornada": 5,
      "newJornada": 6,
      "evaluations": 14,
      "updatedMembers": 6,
      "clearedSquads": 6
    }
  ]
}
```

**Console global**:
```
=============================================================
üåç CERRANDO JORNADA PARA TODAS LAS LIGAS...
=============================================================

============================================================
üèÜ Procesando liga: Liga Amigos
============================================================
...
‚úÖ Liga "Liga Amigos" procesada exitosamente

============================================================
üèÜ Procesando liga: Liga Trabajo
============================================================
...
‚úÖ Liga "Liga Trabajo" procesada exitosamente

============================================================
üèÜ Procesando liga: Liga Familia
============================================================
...
‚úÖ Liga "Familia" procesada exitosamente

============================================================
üéâ PROCESO COMPLETADO
============================================================

üìä Resumen Global:
   - Ligas procesadas: 3/3
   - Total apuestas evaluadas: 67
   - Total miembros actualizados: 24
   - Total plantillas vaciadas: 24
```

---

## üì± FRONTEND: Respuesta al Usuario

**Archivo**: `frontend/pages/admin/AdminPanel.tsx`  
**L√≠neas**: 193-215

El frontend recibe la respuesta y muestra:

```
‚úÖ Cambios Abiertos

El proceso ha finalizado correctamente.

üìä RESUMEN GLOBAL:
‚Ä¢ Ligas procesadas: 3
‚Ä¢ Apuestas evaluadas: 67
‚Ä¢ Miembros actualizados: 24
‚Ä¢ Plantillas vaciadas: 24

‚úÖ PERMITIDO:
‚Ä¢ Modificar plantillas
‚Ä¢ Realizar apuestas

üìà NUEVA JORNADA:
‚Ä¢ Jornada activa: 6
‚Ä¢ Estado: Abierto para cambios
```

**Cambio de estado**:
```typescript
setJornadaStatus('open');  // Actualiza el UI
```

**Efecto visual**:
- El bot√≥n "Abrir Cambios" se deshabilita
- Muestra: "Cambios ya permitidos (J6)"

---

## ‚è±Ô∏è Tiempo de Ejecuci√≥n Estimado

- **1 liga con 8 usuarios**: ~30-45 segundos
- **3 ligas con 24 usuarios**: ~1-2 minutos
- **10 ligas con 80 usuarios**: ~5-8 minutos

**Factores que afectan el tiempo**:
- N√∫mero de ligas
- N√∫mero de usuarios por liga
- N√∫mero de apuestas por jornada
- Rate limits de la API Football (delay de 150ms entre consultas)
- Velocidad de conexi√≥n a internet

---

## üìä Resumen de Cambios en Base de Datos

### Tabla `League`
```sql
UPDATE league
SET currentJornada = currentJornada + 1,
    jornadaStatus = 'open'
WHERE id IN (todas las ligas)
```

### Tabla `LeagueMember`
```sql
UPDATE league_member
SET budget = 500 + squadPoints + betProfit,
    bettingBudget = 250,
    points = points + squadPoints
WHERE leagueId IN (todas las ligas)
```

### Tabla `SquadPlayer`
```sql
DELETE FROM squad_player
WHERE squadId IN (todos los squads de todas las ligas)
```

### Tabla `bet_option`
```sql
DELETE FROM bet_option
WHERE leagueId IN (todas las ligas)
  AND jornada = jornadaAnterior
```

### Tabla `Bet`
```sql
-- Primero actualiza
UPDATE bet
SET status = 'won' OR 'lost',
    profit = calculado
WHERE jornada = jornadaAnterior
  AND status = 'pending'

-- Luego elimina
DELETE FROM bet
WHERE jornada = jornadaAnterior
  AND status IN ('won', 'lost')
```

---

## üéØ Conclusi√≥n

Cuando presionas **"Abrir Jornada"** (que internamente es `closeAllJornadas`):

1. ‚úÖ **Eval√∫a TODAS las apuestas** con la API Football
2. ‚úÖ **Calcula puntos de TODAS las plantillas** (11 jugadores √ó N usuarios √ó M ligas)
3. ‚úÖ **Actualiza presupuestos**: `500 + puntos + apuestas`
4. ‚úÖ **Actualiza puntos totales**: acumula los puntos de la jornada
5. ‚úÖ **Vac√≠a TODAS las plantillas** (para empezar de nuevo)
6. ‚úÖ **Elimina opciones de apuestas antiguas**
7. ‚úÖ **Elimina apuestas ya evaluadas**
8. ‚úÖ **Avanza la jornada en +1** para todas las ligas
9. ‚úÖ **Cambia el estado a 'open'** (permite modificaciones)

**Tiempo total**: 1-8 minutos dependiendo del n√∫mero de ligas y usuarios

---

**Fecha**: 2025-01-20  
**Archivos analizados**:
- `frontend/pages/admin/AdminPanel.tsx`
- `frontend/services/JornadaService.ts`
- `backend/src/routes/jornada.routes.ts`
- `backend/src/controllers/jornada.controller.ts`
- `backend/src/services/jornada.service.ts`
