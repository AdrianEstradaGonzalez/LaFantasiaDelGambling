generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String              @id @default(cuid())
  email       String              @unique
  password    String
  name        String?
  isAdmin     Boolean             @default(false)
  leaguesLed  League[]            @relation("LeagueLeader")
  memberships LeagueMember[]
  resetCodes  PasswordResetCode[]
  squads      Squad[]

  @@map("user")
}

model PasswordResetCode {
  id        String   @id @default(cuid())
  userId    String?
  email     String
  codeHash  String
  expiresAt DateTime
  verified  Boolean  @default(false)
  used      Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, expiresAt, used])
}

model League {
  id             String         @id @default(cuid())
  name           String
  leaderId       String
  createdAt      DateTime       @default(now())
  code           String         @unique
  currentJornada Int            @default(1)
  jornadaStatus  String         @default("open")
  division       String         @default("primera")
  isPremium      Boolean        @default(false)
  leader         User           @relation("LeagueLeader", fields: [leaderId], references: [id], onDelete: Cascade)
  members        LeagueMember[]
  squads         Squad[]
  bet_option     bet_option[]
}

model LeagueMember {
  leagueId         String
  userId           String
  points           Int        @default(0)
  joinedAt         DateTime   @default(now())
  budget           Int        @default(500)
  initialBudget    Int        @default(500)
  bettingBudget    Int        @default(250)
  pointsPerJornada Json?
  league           League     @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  bets             Bet[]
  betCombis        BetCombi[]

  @@id([leagueId, userId])
  @@index([userId])
}

model Squad {
  id        String        @id @default(cuid())
  userId    String
  leagueId  String
  name      String        @default("Mi Plantilla")
  formation String
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  league    League        @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  players   SquadPlayer[]

  @@unique([userId, leagueId])
  @@index([userId, leagueId])
}

model SquadPlayer {
  id         String   @id @default(cuid())
  squadId    String
  playerId   Int
  playerName String
  position   String
  role       String
  createdAt  DateTime @default(now())
  pricePaid  Int      @default(1)
  isCaptain  Boolean  @default(false)
  squad      Squad    @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@unique([squadId, position])
  @@index([squadId])
}

model Player {
  id                  Int                   @id
  name                String
  position            String
  teamId              Int
  teamName            String
  teamCrest           String?
  nationality         String?
  shirtNumber         Int?
  photo               String?
  price               Int
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  lastJornadaPoints   Int                   @default(0)
  lastJornadaNumber   Int                   @default(0)
  teamHistory         Int[]                 @default([])
  availabilityInfo    String?
  availabilityStatus  String                @default("AVAILABLE")
  PlayerJornadaPoints PlayerJornadaPoints[]
  stats               PlayerStats[]

  @@index([teamId])
  @@index([position])
  @@index([price])
  @@map("player")
}

model PlayerStats {
  id                   String   @id @default(cuid())
  playerId             Int
  jornada              Int
  season               Int      @default(2025)
  fixtureId            Int
  teamId               Int
  totalPoints          Int      @default(0)
  minutes              Int?
  position             String?
  rating               String?
  captain              Boolean  @default(false)
  substitute           Boolean  @default(false)
  goals                Int?
  assists              Int?
  conceded             Int?
  saves                Int?
  shotsTotal           Int?
  shotsOn              Int?
  passesTotal          Int?
  passesKey            Int?
  passesAccuracy       Int?
  tacklesTotal         Int?
  tacklesBlocks        Int?
  tacklesInterceptions Int?
  duelsTotal           Int?
  duelsWon             Int?
  dribblesAttempts     Int?
  dribblesSuccess      Int?
  dribblesPast         Int?
  foulsDrawn           Int?
  foulsCommitted       Int?
  yellowCards          Int?
  redCards             Int?
  penaltyWon           Int?
  penaltyCommitted     Int?
  penaltyScored        Int?
  penaltyMissed        Int?
  penaltySaved         Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  pointsBreakdown      Json?
  player               Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, jornada, season])
  @@index([playerId, jornada])
  @@index([jornada, season])
  @@map("player_stats")
}

model PlayerSegundaStats {
  id                   String   @id @default(cuid())
  playerId             Int
  jornada              Int
  season               Int      @default(2025)
  fixtureId            Int
  teamId               Int
  totalPoints          Int      @default(0)
  minutes              Int?
  position             String?
  rating               String?
  captain              Boolean  @default(false)
  substitute           Boolean  @default(false)
  goals                Int?
  assists              Int?
  conceded             Int?
  saves                Int?
  shotsTotal           Int?
  shotsOn              Int?
  passesTotal          Int?
  passesKey            Int?
  passesAccuracy       Int?
  tacklesTotal         Int?
  tacklesBlocks        Int?
  tacklesInterceptions Int?
  duelsTotal           Int?
  duelsWon             Int?
  dribblesAttempts     Int?
  dribblesSuccess      Int?
  dribblesPast         Int?
  foulsDrawn           Int?
  foulsCommitted       Int?
  yellowCards          Int?
  redCards             Int?
  penaltyWon           Int?
  penaltyCommitted     Int?
  penaltyScored        Int?
  penaltyMissed        Int?
  penaltySaved         Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  pointsBreakdown      Json?

  @@unique([playerId, jornada, season])
  @@index([playerId, jornada])
  @@index([jornada, season])
  @@map("player_segunda_stats")
}

model PlayerJornadaPoints {
  playerId  Int
  season    Int      @default(2025)
  pointsJ1  Int?
  pointsJ2  Int?
  pointsJ3  Int?
  pointsJ4  Int?
  pointsJ5  Int?
  pointsJ6  Int?
  pointsJ7  Int?
  pointsJ8  Int?
  pointsJ9  Int?
  pointsJ10 Int?
  pointsJ11 Int?
  pointsJ12 Int?
  pointsJ13 Int?
  pointsJ14 Int?
  pointsJ15 Int?
  pointsJ16 Int?
  pointsJ17 Int?
  pointsJ18 Int?
  pointsJ19 Int?
  pointsJ20 Int?
  pointsJ21 Int?
  pointsJ22 Int?
  pointsJ23 Int?
  pointsJ24 Int?
  pointsJ25 Int?
  pointsJ26 Int?
  pointsJ27 Int?
  pointsJ28 Int?
  pointsJ29 Int?
  pointsJ30 Int?
  pointsJ31 Int?
  pointsJ32 Int?
  pointsJ33 Int?
  pointsJ34 Int?
  pointsJ35 Int?
  pointsJ36 Int?
  pointsJ37 Int?
  pointsJ38 Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@id([playerId, season])
  @@map("player_jornada_points")
}

model Bet {
  id           String       @id @default(cuid())
  leagueId     String
  userId       String
  jornada      Int
  matchId      Int
  betType      String
  betLabel     String
  odd          Float
  amount       Int
  potentialWin Int
  status       String       @default("pending")
  createdAt    DateTime     @default(now())
  apiBetId     Int?
  apiEndpoint  String?
  apiOperator  String?
  apiStatKey   String?
  apiValue     String?
  awayTeam     String?
  evaluatedAt  DateTime?    @db.Timestamp(6)
  homeTeam     String?
  homeCrest    String?
  awayCrest    String?
  combiId      String?
  betCombi     BetCombi?    @relation(fields: [combiId], references: [id], onDelete: Cascade)
  leagueMember LeagueMember @relation(fields: [leagueId, userId], references: [leagueId, userId], onDelete: Cascade)

  @@index([leagueId, userId])
  @@index([jornada])
  @@index([status])
  @@index([matchId])
  @@index([combiId])
  @@map("bet")
}

model BetCombi {
  id           String       @id @default(cuid())
  leagueId     String
  userId       String
  jornada      Int
  totalOdd     Float
  amount       Int
  potentialWin Int
  status       String       @default("pending")
  createdAt    DateTime     @default(now())
  evaluatedAt  DateTime?    @db.Timestamp(6)
  selections   Bet[]
  leagueMember LeagueMember @relation(fields: [leagueId, userId], references: [leagueId, userId], onDelete: Cascade)

  @@index([leagueId, userId])
  @@index([jornada])
  @@index([status])
  @@map("bet_combi")
}

model bet_option {
  id            String   @id
  leagueId      String
  jornada       Int
  matchId       Int
  homeTeam      String
  awayTeam      String
  betType       String
  betLabel      String
  odd           Float    @default(1.0)
  createdAt     DateTime @default(now())
  options       Json?
  awayTeamCrest String?
  homeTeamCrest String?
  League        League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId, jornada])
  @@index([matchId])
}

model PlayerSegunda {
  id                 Int      @id
  name               String
  position           String
  teamId             Int
  teamHistory        Int[]    @default([])
  teamName           String
  teamCrest          String?
  nationality        String?
  shirtNumber        Int?
  photo              String?
  price              Int
  availabilityStatus String   @default("AVAILABLE")
  availabilityInfo   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  lastJornadaPoints  Int      @default(0)
  lastJornadaNumber  Int      @default(0)

  @@index([teamId])
  @@index([position])
  @@index([price])
  @@map("player_segunda")
}

model PlayerPremier {
  id                 Int      @id
  name               String
  position           String
  teamId             Int
  teamHistory        Int[]    @default([])
  teamName           String
  teamCrest          String?
  nationality        String?
  shirtNumber        Int?
  photo              String?
  price              Int
  availabilityStatus String   @default("AVAILABLE")
  availabilityInfo   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  lastJornadaPoints  Int      @default(0)
  lastJornadaNumber  Int      @default(0)

  @@index([teamId])
  @@index([position])
  @@index([price])
  @@map("player_premier")
}

model PlayerPremierStats {
  id                   String   @id @default(cuid())
  playerId             Int
  jornada              Int
  season               Int      @default(2025)
  fixtureId            Int
  teamId               Int
  totalPoints          Int      @default(0)
  minutes              Int?
  position             String?
  rating               String?
  captain              Boolean  @default(false)
  substitute           Boolean  @default(false)
  goals                Int?
  assists              Int?
  conceded             Int?
  saves                Int?
  shotsTotal           Int?
  shotsOn              Int?
  passesTotal          Int?
  passesKey            Int?
  passesAccuracy       Int?
  tacklesTotal         Int?
  tacklesBlocks        Int?
  tacklesInterceptions Int?
  duelsTotal           Int?
  duelsWon             Int?
  dribblesAttempts     Int?
  dribblesSuccess      Int?
  dribblesPast         Int?
  foulsDrawn           Int?
  foulsCommitted       Int?
  yellowCards          Int?
  redCards             Int?
  penaltyWon           Int?
  penaltyCommitted     Int?
  penaltyScored        Int?
  penaltyMissed        Int?
  penaltySaved         Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  pointsBreakdown      Json?

  @@unique([playerId, jornada, season])
  @@index([playerId, jornada])
  @@index([jornada, season])
  @@map("player_premier_stats")
}

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  ligaId    String   @default("default")
  token     String
  platform  String   @default("android") // 'ios' or 'android'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, ligaId])
  @@index([ligaId])
  @@index([userId])
  @@map("device_token")
}

model SquadHistory {
  id               String   @id @default(cuid())
  userId           String
  leagueId         String
  jornada          Int
  formation        String
  players          Json     // Array de {playerId, playerName, position, role, pricePaid, isCaptain}
  totalValue       Int      // Suma de pricePaid de todos los jugadores
  captainPosition  String?
  createdAt        DateTime @default(now())

  @@unique([userId, leagueId, jornada])
  @@index([leagueId, jornada])
  @@index([userId, leagueId])
  @@map("squad_history")
}

model DailyOffer {
  id            String   @id @default(cuid())
  date          DateTime @default(now()) @db.Date
  playerId      Int
  playerName    String
  division      String   // 'primera', 'segunda', 'premier'
  originalPrice Int      // Precio original del jugador
  offerPrice    Int      // Precio con descuento (20% menos)
  discount      Int      // Porcentaje de descuento (siempre 20)
  createdAt     DateTime @default(now())

  @@unique([date, playerId])
  @@index([date, division])
  @@index([playerId])
  @@map("daily_offer")
}

model OfferHistory {
  id        String   @id @default(cuid())
  playerId  Int
  lastOffer DateTime @db.Date
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId])
  @@index([lastOffer])
  @@map("offer_history")
}
